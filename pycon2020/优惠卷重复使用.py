from flask import Flask, session, request
from util import CaptchaTool
import requests
from flask import Flask
from flask import request,render_template,request
import pymysql
pymysql.install_as_MySQLdb()
from flask_sqlalchemy import SQLAlchemy
import random

app = Flask(__name__)
app.config["SECRET_KEY"] = "htftime"
app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql://pychon:wsljx123@172.20.10.13:3306/pychon'
db = SQLAlchemy(app)
@app.route("/login",methods=['GET'])
def zhuce1():
    new_captcha = CaptchaTool()
    img, code = new_captcha.get_verify_code()
    session["code"] = code
    code  = session.get("code")
    return render_template('login.html',img_stream=img.decode('ascii'))

@app.route("/login",methods=['POST'])
def zhuce():
    s_code=session.get("code")
    print("我的code"+str(s_code))
    username = request.form['username']
    password = request.form['password']
    code = request.form['code']
    if code != s_code:
        return "验证码错误"
    else:
        sql1 = "select * from newuser where username=:username && password=:password"
        result = db.session.execute(sql1,{"username":username,"password":password})
        userinfo = result.fetchall()
        if len(userinfo) > 0:
            print(userinfo)
            session['username'] = userinfo[0][1]
            session['uid'] = userinfo[0][0]
            return "登陆成功"
        else:
            return "登陆失败"
@app.route("/home",methods=['GET'])
def home():
    if session.get('username'):
        data = {'username':session.get('username'),'userid':session.get('uid')}
        return render_template('home.html',**data)
    else:
        return "请登录小老弟"

@app.route("/info",methods=['GET'])
def infos():
    id = request.args.get('id')
    sql1 = "select * from newuser where id=:id"
    result = db.session.execute(sql1,{"id":id})
    userinfo = result.fetchall()
    print(userinfo)
    data = {'username':userinfo[0][1],'email':userinfo[0][3],'phone':userinfo[0][5],'name':userinfo[0][5]}
    return render_template('info.html',**data)

@app.route("/shop",methods=['GET'])
def shopone():
    sql1 = "select * from shopinfo"
    result = db.session.execute(sql1)
    shopinfo = result.fetchall()
    data = {"username":session.get('username'),'payinfo':shopinfo[0][2],'shopinfo':shopinfo[0][1]}
    return render_template('shop.html',**data)

@app.route("/shop",methods=['POST'])
def shoptwo():
    payinfo = request.form['pay']
    yhj = request.form['yhj']
    sql1 = "select * from newuser where username=:username"
    result = db.session.execute(sql1,{"username":str(session.get('username'))})
    userinfo = result.fetchall()
    snedpay = userinfo[0][6]
    sql2 = "select * from yhj where name=:name"
    result = db.session.execute(sql2,{"name":yhj})
    yhjinfo = result.fetchall()
    if len(yhjinfo)>0:
        yhja = yhjinfo[0][2]
        jg = int(payinfo)-int(yhja)
        if jg <= 0:
            return "购买成功"
        else:
            jg2 = int(snedpay) - jg
            if jg2 < 0:
                return "购买失败余额不足"
            else:
                sql3 = "update newuser set pay=:newpay where username=:username"
                result = db.session.execute(sql3,{"username":str(session.get('username')),"newpay":str(jg2)})
                return "购买成功"

    else:
        return "优惠券失效"
    return "nb"
app.run(host='0.0.0.0', port=5001, debug='True')
