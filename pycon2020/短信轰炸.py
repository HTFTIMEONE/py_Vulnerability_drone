from flask import Flask, session, request
from util import CaptchaTool
import requests
from flask import Flask
from flask import request,render_template,request
import pymysql
pymysql.install_as_MySQLdb()
from flask_sqlalchemy import SQLAlchemy
import random


sendm={
    'appid':'37697',
    'signature':'9a03189cd5185edaf25d176459d899f2',
    'url':'https://api.mysubmail.com/message/send.json',
    'content':"【htftime】您的短信验证码：%s，请在10分钟内输入"
    }
app = Flask(__name__)
app.config["SECRET_KEY"] = "htftime"
app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql://pychon:wsljx123@192.168.3.72:3306/pychon'
db = SQLAlchemy(app)

def sendma(sendcode,phone):
    data={
        'appid':sendm['appid'],
        'signature':sendm['signature'],
        'content':sendm['content'] % sendcode,
        'to':phone
    }
    res =requests.post(sendm['url'],data=data)
    print(res.text)

@app.route("/res",methods=['GET'])
def reso():
    phone = request.args.get("phone")
    sendcode = str(random.randint(0,9))+str(random.randint(0,9))+str(random.randint(0,9))+str(random.randint(0,9))
    session["sendcode"]=sendcode
    sendma(sendcode,phone)
    return "1"


@app.route("/reister",methods=['GET'])
def zhuce1():
    try:
        sendcode = session["sendcode"]
        print(sendcode)
    except:
        pass
    new_captcha = CaptchaTool()
    img, code = new_captcha.get_verify_code()
    session["code"] = code
    code  = session.get("code")
    return render_template('register2.html',img_stream=img.decode('ascii'))

@app.route("/reister",methods=['POST'])
def zhuce():
    s_code=session.get("code")
    print("我的code"+str(s_code))
    username = request.form['username']
    password = request.form['password']
    email = request.form['email']
    phone = request.form['phone']
    name = request.form['name']
    code = request.form['code']
    if code != s_code:
        return "验证码错误"
    else:
        sql1 = "select * from newuser where username=:username"
        sql2 = "insert into newuser(username,password,email,phone,name) values(:username,:password,:email,:phone,:name)"
        result = db.session.execute(sql1,{"username":username})
        if len(result.fetchall()) > 0:
            return "该用户已经被注册"
        else:
            result = db.session.execute(sql2,{"username":username,"password":password,"email":email,"phone":phone,"name":name})
            if result:
                return "注册成功"
            else:
                return "注册失败"
if __name__ == "__main__":
    app.run(host='0.0.0.0', port=5000, debug='True')
